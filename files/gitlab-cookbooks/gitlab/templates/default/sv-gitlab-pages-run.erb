#!/bin/bash
set -e # fail on errors

# Redirect stderr -> stdout
exec 2>&1

<%= render("mount_point_check.erb") %>

cd <%= @options[:dir] %>

<% external_http = [ @options[:external_http] ].flatten.compact  %>
<% external_https = [ @options[:external_https] ].flatten.compact  %>

exec /usr/bin/env SSL_CERT_FILE=/opt/gitlab/embedded/ssl/certs/cacert.pem \
    /opt/gitlab/embedded/bin/gitlab-pages \
    <% if @options[:listen_proxy] %>
    -listen-proxy="<%= @options[:listen_proxy] %>" \
    <% end %>
    <% external_http.each do |spec| %>
    -listen-http="<%= spec %>" \
    <% end %>
    <% external_https.each do |spec| %>
    -listen-https="<%= spec %>" \
    <% end %>
    <% unless external_https.empty? %>
    -root-cert="<%= @options[:cert] %>" \
    -root-key="<%= @options[:cert_key] %>" \
    <% end %>
    <% if @options[:metrics_address] %>
    -metrics-address="<%= @options[:metrics_address] %>" \
    <% end %>
    -daemon-uid="$(id -u "<%= @options[:username] %>")" \
    -daemon-gid="$(id -g "<%= @options[:username] %>")" \
    -daemon-inplace-chroot=<%= @options[:inplace_chroot] %> \
    \
    -pages-domain="<%= @options[:domain] %>" \
    -pages-root="<%= @options[:pages_root] %>" \
    <% if @options[:status_uri] %>
    -pages-status="<%= @options[:status_uri] %>" \
    <% end %>
    <% if @options[:max_connections] %>
    -max-conns=<%= @options[:max_connections] %> \
    <% end %>
    <% if @options[:log_format] %>
    -log-format="<%= @options[:log_format] %>" \
    <% end %>
    <% if @options[:log_verbose] %>
    -log-verbose \
    <% end %>
    \
    -redirect-http=<%= @options[:redirect_http] %> \
    -use-http2=<%= @options[:use_http2] %> \
    \
    <% if @options[:artifacts_server] %>
    -artifacts-server="<%= @options[:artifacts_server_url] %>" \
    <% if @options[:artifacts_server_timeout] %>
    -artifacts-server-timeout=<%= @options[:artifacts_server_timeout] %> \
    <% end %>
    <% end %>
    \
    <% if @options[:access_control] %>
    -auth-client-id=<%= @options[:gitlab_id] %> \
    -auth-client-secret=<%= @options[:gitlab_secret] %> \
    -auth-redirect-uri="<%= @options[:auth_redirect_uri] %>" \
    -auth-server="<%= @options[:auth_server] %>" \
    -auth-secret=<%= @options[:auth_secret] %> \
    <% end %>
    \
    <% if @options[:admin_https_cert] %>
    -admin-https-cert="<%= @options[:admin_https_cert] %>" \
    <% end %>
    <% if @options[:admin_https_key] %>
    -admin-https-key="<%= @options[:admin_https_key] %>" \
    <% end %>
    <% if @options[:admin_https_listener] %>
    -admin-https-listener="<%= @options[:admin_https_listener] %>" \
    <% end %>
    -admin-secret-path="<%= @options[:dir] %>/admin.secret" \
    -admin-unix-listener="<%= @options[:dir] %>/admin.socket" \
