#!/bin/sh
set -e # fail on errors

# Redirect stderr -> stdout
exec 2>&1

<%= render("mount_point_check.erb") %>

cd <%= @options[:dir] %>

exec chpst -e /opt/gitlab/etc/gitlab-workhorse/env -P \
  -U <%= @options[:username] %>:<%= @options[:groupname] %> \
  -u <%= @options[:username] %>:<%= @options[:groupname] %> \
  /opt/gitlab/embedded/bin/gitlab-workhorse \
    -listenNetwork <%= @options[:listen_network] %> \
    -listenUmask <%= @options[:listen_umask] %> \
    -listenAddr <%= @options[:listen_addr] %> \
    -authBackend <%= @options[:auth_backend] %><%= @options[:relative_url] %> \
    -authSocket <%= @options[:auth_socket] %> \
    -documentRoot /opt/gitlab/embedded/service/gitlab-rails/public \
    -pprofListenAddr <%= @options[:pprof_listen_addr] %>\
    <% if @options[:proxy_headers_timeout] %>
    -proxyHeadersTimeout <%= @options[:proxy_headers_timeout] %> \
    <% end %>
    <% if @options[:api_limit] %>
    -apiLimit <%= @options[:api_limit] %> \
    <% end %>
    <% if @options[:api_queue_duration] %>
    -apiQueueDuration <%= @options[:api_queue_duration] %> \
    <% end %>
    <% if @options[:api_queue_limit] %>
    -apiQueueLimit <%= @options[:api_queue_limit] %> \
    <% end %>
    <% unless @options[:prometheus_listen_addr].empty? %>
    -prometheusListenAddr <%= @options[:prometheus_listen_addr] %> \
    <% end %>
    -secretPath /opt/gitlab/embedded/service/gitlab-rails/.gitlab_workhorse_secret \
    <% if @options[:api_ci_long_polling_duration] %>
    -apiCiLongPollingDuration <%= @options[:api_ci_long_polling_duration] %> \
    <% end %>
    <% if @options[:log_format] %>
    -logFormat <%= @options[:log_format] %> \
    <% end %>
    -config config.toml \

# Do not remove this line; it prevents trouble with the trailing backslashes above.
