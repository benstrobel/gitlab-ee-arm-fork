#!/bin/sh

cd <%= @options[:dir] %>/working

exec 2>&1
<%= render("make_metrics_rundir.erb", cookbook: 'gitlab') %>
<%= render("mount_point_check.erb", cookbook: 'gitlab') %>
exec chpst -e /opt/gitlab/etc/gitlab-rails/env -P \
  -U <%= @options[:username] %>:<%= @options[:groupname] %> \
  -u <%= @options[:username] %>:<%= @options[:groupname] %> \
  /usr/bin/env \
    prometheus_multiproc_dir="${prometheus_run_dir}" \
    /opt/gitlab/embedded/service/gitlab-rails/bin/sidekiq-cluster \
      -e <%= @options[:env_dir] %> \
      -r /opt/gitlab/embedded/service/gitlab-rails \
      <% if @options[:interval] %>
      -i <%= @options[:interval] %> \
      <% end %>
      <% if @options[:max_concurrency] %>
      -m <%= @options[:max_concurrency] %> \
      <% end %>
      <% @options[:queue_groups].each do |queue| %>
        <%= queue %> \
      <% end %>
      <% if @options[:negate] %>
      --negate \
      <% end %>

# Do not remove this line; it prevents trouble with the trailing backslashes above.
