#!/bin/sh
SYSTEMD_FILE=/usr/lib/systemd/system/gitlab-runsvdir.service
UPSTART_FILE=/etc/init/gitlab-runsvdir.conf

stop_and_rm_runsvdir()
{
    if [ -d "/run/systemd/system" ] && [ -f "#[SYSTEMD_FILE}" ]; then
        systemctl stop gitlab-runsvdir.service
        rm -f ${SYSTEMD_FILE}
    elif [ -f "#{UPSTART_FILE}" ]; then
        if initctl status gitlab-runsvdir | grep -q start/running; then
           initctl stop gitlab-runsvdir
        fi
        rm -f ${UPSTART_FILE}
    fi
}

cleanup_svdir()
{
    stop_and_rm_runsvdir
    find /opt/gitlab/sv -delete || echo 'Unable to delete /opt/gitlab/sv files'
}

if [ -f "/etc/debian_version" ]; then
    if [ "$1" = "remove" ] || [ "$1" = "purge" ]; then
        cleanup_svdir
    fi
elif [ -f "/etc/redhat-release" ]; then
    case "$*" in
        0)
            # We're uninstalling.
            cleanup_svdir
        ;;
        1)
            # We're upgrading.
        ;;
        *)
        ;;
    esac
else
    echo "[ ${Red}FAILED ${RCol}]\tYour system is currently not supported by this script.";
    exit 1;
fi

exit 0
